<!doctype html><html lang="en"><head>
<meta charset="UTF-8" name="viewport"
      content="width=device-width, initial-scale=1,
               maximum-scale=1, user-scalable=yes">
<script src="https://unpkg.com/preact/dist/preact.min.js"></script>
<link
  rel="stylesheet"
  href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
/>
<title>Hello, World!</title><script>
const render = function () {
    const all_apps = {}

    function refresh_all() {
        for(const id in all_apps)
            all_apps[id]()
    }

    window.addEventListener('hashchange', refresh_all)
    window.addEventListener('resize', refresh_all)

    return function(id, app, props) {
        function refresh() {
            var msec = (new Date()).getTime()

            if(null === document.getElementById(id)) {
                const node = document.createElement('div')
                node.setAttribute('id', id)
                document.body.appendChild(node)
            }

            preact.render(
                preact.h(page, props),
                document.getElementById(id))

            msec = (new Date()).getTime() - msec
            if(msec > 20)
                console.log('refresh(' + id + ') msec(' + msec + ')')
        }

        const page = app(preact.h, refresh)
        all_apps[id] = refresh
        refresh()
    }
}()
</script></head><body></body><script>
function location_hash() {
    return location.hash? location.hash.substring(1): ''
}

function Components(h) {
    return {
        Container: function(props, ...children) {
            return h('div', {class: 'div container'},
                h('div', props, children))
        }
    }
}

// Links
render(1, function(dom, refresh) {
    const {Container} = Components(dom)

    const a = (text, href) => dom('a', {href: href}, text)

    return function(props) {
        return dom('nav', {class: 'navbar navbar-default'},
            a('Calculators', '#Calculators'),
            a('Clocks', '#Clocks'),
            a('Home', '#'))
    }
})

// Calculator
render(2, function(dom, refresh) {
    const {Container} = Components(dom)

    var color = 'white'
    var expression = 'Type some maths expression'

    function updateExpression(expr) {
        expression = expr
        refresh()
    }

    function setColor(c) {
        color = c
        refresh()
    }

    function Label(props) {
        var value = expression

        try {
            value = eval(value)
        } catch(error) {
        }

        return dom('div', {}, value)
    }

    function Text(props) {
        return dom('input', {type: 'text',
            onkeyup: (e) => updateExpression(e.target.value)})
    }

    return function(props) {
        if(location_hash() == 'Clocks')
            return dom('div', {}, '')

        return Container(
            {
                onMouseOver: e => setColor('lightgrey'),
                onMouseOut: e => setColor('white'),
                style: {backgroundColor: color}
            },
            Label(props),
            Text(props))
    }
})

// Clock
setInterval(() => render(5, function(dom, refresh) {
    const {Container} = Components(dom)

    var color = 'red'

    function setColor(c) {
        color = c
        refresh()
    }

    function Time(props) {
        const today = new Date()

        return dom('div',
            {
                onmouseover: e => setColor('green'),
                style: {color: color}
            },
            today.getTime())
    }

    return function(props) {
        if(location_hash() == 'Calculators')
            return dom('div', {}, '')

        return Container({}, Time(props))
    }
}), 1000)

// Location
render(6, function(dom, refresh) {
    const {Container} = Components(dom)

    const msg = 'Click here to get location'
    let location = msg

    function GetLocation() {
        if(msg != location) {
            location = msg
            return refresh()
        }

        navigator.geolocation.getCurrentPosition(function(pos){
            location = JSON.stringify({
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude,
                accuracy: pos.coords.accuracy}, null, 4)

            refresh()
        })
    }

    return function(props) {
        return Container({},
            dom('pre', {onClick: GetLocation}, location))
    }
})

// Code
render(7, function(dom, refresh) {
    const {Container} = Components(dom)

    const url = 'https://magicray.github.io/apps/template.html'
    const msg = 'Click here to fetch the source code'
    let code = msg

    function FetchCode() {
        if(code != msg) {
            code = msg
            return refresh()
        }

        code = 'Fetching....'
        refresh()

        fetch(url)
            .then(function(response){
                response.text().then(function(text){
                    code = text
                    refresh()
                })
            })
            .catch(function(err){
                code = err
                refresh()
            })
    }

    return function(props) {
        return Container({},
            dom('pre', {onClick: FetchCode}, code))
    }
})
</script></html>
