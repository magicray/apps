<!DOCTYPE html>
<html>

<link rel="stylesheet" href="/apps/bootstrap-3.3.7.css">
<script src="/apps/external.min.js"></script>

<head>
  <meta charset="utf-8">
  <meta name = "viewport"
        content = "width = device-width,
                   initial-scale = 1.0,
                   maximum-scale = 1.0,
                   user-scalable = no">
</head>

<script>
class App extends React.Component {
    constructor(props) {
        super(props)

        const actions = {}
        _.map(App.r, (v, k) => {
            actions[k] = function() {
                return {
                    type: k,
                    payload: arguments
                }
            }
        })

        App.connector = ReactRedux.connect(
            (state) => {return {state}},
            actions)

        App.store = Redux.createStore(
            (state, action) => {
                if(undefined === App.r[action.type])
                    return state

                state = JSON.parse(JSON.stringify(state))

                try {
                    App.r[action.type](state, ...action.payload)
                } catch(e) {
                    console.log(e)
                }

                return state
            }, App.state)

        console.log('Router.constructor: This should happen only once')
    }

    componentDidMount() {
        window.onhashchange = () => this.setState({})
    }

    render() {
        const parser = document.createElement('a')
        parser.href = window.location

        const component = this.props.pages[parser.hash] || this.props.default

        return React.createElement(
            ReactRedux.Provider,
            {store: App.store},
            React.createElement(App.connector(component)))
    }

    static dispatchPromise(action, promise) {
        App.store.dispatch({type: `${action}_PromisePending`, payload: []})

        promise.then(r => {App.store.dispatch(
            {type: `${action}_PromiseResolved`, payload: [r]})
        }).catch(e => {App.store.dispatch(
            {type: `${action}_PromiseRejected`, payload: [e]})
        })
    }

    static stringify(obj) {
        return JSON.stringify(obj, null, 4)
    }
}
App.r = {}
</script>

<script src="/apps/learn.js"></script>

<body>
    <script>
        ReactDOM.render(React.createElement(App, App.pages()), document.body)
    </script>
</body>
</html>
