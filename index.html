
<!DOCTYPE html>
<link rel="stylesheet" href="https://magicray.github.io/apps/bootstrap.css">
<script src="https://magicray.github.io/apps/react-app-bundle.min.js"></script>
<meta name = "viewport"
      content = "width = device-width,
                 initial-scale = 1.0,
                 maximum-scale = 1.0,
                 user-scalable = no">

<body/>
<script>
function GPS(props) {
    const onClick = (e) => {
        if ('Show Address' === props.state.gps.action) {
            props.actions.fetchAddress(
                props.state.gps.latitude,
                props.state.gps.longitude)
        } else {
            props.actions.renderGPS()
        }
    }

    const {div, a, pre} = React.DOM

    return div(null,
            e(Menu, props),
            div({className: 'container'},
                pre(null, props.state.gps.val),
                a({className: 'btn btn-primary', onClick},
                    props.state.gps.action)))
}

function Text(props) {
    const processedText = props.state.flag ?
                          props.state.text.split('').reverse().join('') :
                          props.state.text

    const textProps = {
        type: 'text',
        className: 'form-control',
        value: props.state.text,
        onChange: e => props.actions.updateText(e.target.value)
    }

    const buttonProps = {
        className: 'btn btn-primary',
        onClick: props.actions.toggleText
    }

    const {div, a, input, label} = React.DOM

    return div(null,
            e(Menu, props),
            div({className: 'container'},
                input(textProps),
                label({className: 'form-control'}, processedText),
                a(buttonProps, 'Toggle')))
}

function Props(props) {
    const {div, pre} = React.DOM

    return div(null,
            e(Menu, props),
            div({className: 'container'},
                pre(null, JSON.stringify(props, null, 4))))
}

function Home(props) {
    const {div, h1} = React.DOM

    return div(null,
            e(Menu, props),
                div({className: 'jumbotron container'},
                    h1(null, 'Example')))
}

function Menu(props) {
    const {div, a, ul, li} = React.DOM

    return div({className: "navbar navbar-default"},
        div({className: "container"},
            div({className: "navbar-header"},
               a({className: "navbar-brand", href: '#/homePage'},
                   'Learn React')),
            div({className: "navbar-collapse navbar-responsive-collapse"},
                ul({className: "nav navbar-nav"},
                    li(null, a({href: '#/renderText'}, 'Text')),
                    li(null, a({href: '#/renderProps'}, 'Props')),
                    li(null, a({href: '#/renderGPS'}, 'GPS'))))))
}

const state = {
    text: 'Hello World',
    flag: true,
    gps: {}
}

const actions = {}
const reducers = {}

reducers.homePage = (state) => Home
reducers.renderText = (state) => Text
reducers.renderProps = (state) => Props

actions.renderGPS = function() {
    return new Promise(resolve => {
        navigator.geolocation.getCurrentPosition((pos) => {
            resolve(pos.coords)})
    })
}

actions.fetchAddress = function(latitude, longitude) {
    const maps = 'https://maps.googleapis.com/maps/api/geocode/json?';
    const latlng = latitude + ',' + longitude;

    return axios.get(`${maps}latlng=${latlng}`)
}

reducers.renderGPS_PromisePending = function(state) {
    state.gps.val = 'Fetching Location'
    state.gps.action = 'Show Location'
    return GPS
}

reducers.renderGPS_PromiseResolved = function(state, coords) {
    state.gps = {
        latitude: coords.latitude,
        longitude: coords.longitude,
        accuracy: coords.accuracy,
        action: 'Show Address',
        val: JSON.stringify({
            latitude: coords.latitude,
            longitude: coords.longitude,
            accuracy: coords.accuracy}, null, 4)}
}

reducers.fetchAddress_PromisePending = function(state) {
    state.gps.val = 'Fetching Address'
}

reducers.fetchAddress_PromiseResolved = function(state, response) {
    state.gps.action = 'Show Location'
    state.gps.val = response.data.results[0]['formatted_address'].replace(
        /, */g, '\n')
}

reducers.fetchAddress_PromiseRejected = function(state, error) {
    state.gps.val = App.stringify(error)
    state.gps.action = 'Show Address'
}

reducers.updateText = function(state, text) {
    state.text = text
}

reducers.toggleText = function(state) {
    state.flag = state.flag? false: true
}

App.mount(state, actions, reducers)
</script>
